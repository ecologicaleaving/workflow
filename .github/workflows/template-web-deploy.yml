name: Build & Deploy

on:
  push:
    branches: ['**']
  delete:
    branches: ['**']

env:
  NODE_VERSION: '22'

jobs:
  cleanup:
    if: github.event_name == 'delete'
    name: Cleanup branch environment
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      - name: Remove branch webroot
        run: |
          SLUG=$(echo "${{ github.event.ref }}" | sed 's|/|-|g' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "rm -rf /var/www/test-maestro/b/${SLUG} && echo 'Rimosso ambiente ${SLUG}'"
      - name: Notify
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "ciccio-notify 'üóëÔ∏è maestroweb / ${{ github.event.ref }} ‚Äî ambiente rimosso'" \
            || true

  build-and-deploy:
    if: github.event_name == 'push'
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set deploy target
        id: target
        run: |
          BRANCH="${{ github.ref_name }}"
          SLUG=$(echo "$BRANCH" | sed 's|/|-|g' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
          if [ "$BRANCH" = "master" ] || [ "$BRANCH" = "main" ]; then
            echo "webroot=/var/www/maestroweb"           >> $GITHUB_OUTPUT
            echo "base_path="                            >> $GITHUB_OUTPUT
            echo "url=https://maestro.8020solutions.org" >> $GITHUB_OUTPUT
          else
            echo "webroot=/var/www/test-maestro/b/${SLUG}"                          >> $GITHUB_OUTPUT
            echo "base_path=/b/${SLUG}"                                             >> $GITHUB_OUTPUT
            echo "url=https://test-maestro.8020solutions.org/b/${SLUG}/"            >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          NEXT_PUBLIC_USE_ZCS_MOCK: 'false'
          NEXT_PUBLIC_USE_AUTH_MOCK: 'false'
          NEXT_PUBLIC_BASE_PATH: ${{ steps.target.outputs.base_path }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create webroot
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "mkdir -p ${{ steps.target.outputs.webroot }}"

      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            out/ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ steps.target.outputs.webroot }}/

      - name: Purge Cloudflare cache
        run: |
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"purge_everything":true}' | jq -r '.success // "purge-skipped"'

      - name: Health check
        run: |
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.target.outputs.url }}" || echo "000")
          echo "‚Üí HTTP ${STATUS} ‚Äî ${{ steps.target.outputs.url }}"

      - name: Notify Ciccio
        if: always()
        run: |
          EMOJI=$([ "${{ job.status }}" = "success" ] && echo "‚úÖ" || echo "‚ùå")
          SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "ciccio-notify '${EMOJI} maestroweb / ${{ github.ref_name }} (${SHORT})\nüîó ${{ steps.target.outputs.url }}\nStatus: ${{ job.status }}'" \
            || true
