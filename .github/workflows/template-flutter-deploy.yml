name: Build & Deploy APK
# ============================================================
# TEMPLATE ‚Äî copia in ogni repo Flutter come:
# .github/workflows/build-apk.yml
#
# Secrets richiesti:
#   VPS_SSH_KEY   ‚Äî chiave privata SSH (github-actions-deploy)
#   VPS_HOST      ‚Äî IP VPS (46.225.60.101)
#   VPS_USER      ‚Äî utente SSH (root)
#   TELEGRAM_TOKEN / TELEGRAM_CHAT_ID ‚Äî per notifiche (opzionale)
#
# Flusso automatico card Project board:
#   commit ‚Üí review-ready ‚Üí PUSH
#   CI deploy OK ‚Üí deployed-test ‚Üí Test (notifica Davide)
# ============================================================

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    name: Build APK & Deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Extract version & branch info
        id: info
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          BRANCH="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          PR_NUMBER="${{ github.event.pull_request.number }}"
          ISSUE_NUM=$(echo "$BRANCH" | grep -oP 'issue-\K\d+' || echo "")
          echo "version=$VERSION"       >> $GITHUB_OUTPUT
          echo "branch=$BRANCH"         >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA"   >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER"   >> $GITHUB_OUTPUT
          echo "issue_num=$ISSUE_NUM"   >> $GITHUB_OUTPUT

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Build APK (debug arm64)
        run: flutter build apk --debug --target-platform android-arm64 || true
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"

      - name: Find & rename APK
        id: apk
        run: |
          APK_PATH=$(find build -name "*.apk" 2>/dev/null | grep -v "intermediates\|test" | head -1)
          [ -z "$APK_PATH" ] && echo "ERROR: no APK found" && exit 1
          PR="${{ steps.info.outputs.pr_number }}"
          SHA="${{ steps.info.outputs.short_sha }}"
          REPO="${{ github.event.repository.name }}"
          [ -n "$PR" ] && APK_NAME="${REPO}-pr${PR}-${SHA}.apk" || APK_NAME="${REPO}-v${{ steps.info.outputs.version }}-${SHA}.apk"
          cp "$APK_PATH" "$APK_NAME"
          echo "name=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Deploy APK to app-hub
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "mkdir -p /var/www/app-hub/downloads/test"
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "${{ steps.apk.outputs.name }}" \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/app-hub/downloads/test/

      # ‚îÄ‚îÄ Cuore del workflow: label + card board ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Mark deployed-test & move card to Test
        if: success()
        run: |
          ISSUE="${{ steps.info.outputs.issue_num }}"
          REPO="${{ github.repository }}"
          if [ -n "$ISSUE" ]; then
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
              "export PATH=\$PATH:/root/go/bin && \
               gh issue edit $ISSUE --repo $REPO \
                 --remove-label review-ready \
                 --add-label deployed-test 2>/dev/null || true && \
               python3 /root/.openclaw/workspace-ciccio/scripts/project_board.py \
                 $REPO $ISSUE Test 2>/dev/null || true" || true
          fi

      - name: Comment PR with APK link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const name = '${{ steps.apk.outputs.name }}';
            const url  = `https://apps.8020solutions.org/downloads/test/${name}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üì≤ **APK pronto!**\n\nüîó [${name}](${url})\n\n> Installa direttamente sul dispositivo Android.`
            });

      - name: Create GitHub Release (master only)
        if: (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.info.outputs.version }}
          name: v${{ steps.info.outputs.version }}
          files: ${{ steps.apk.outputs.name }}

      - name: Notify Ciccio
        if: always()
        run: |
          EMOJI=$([ "${{ job.status }}" = "success" ] && echo "‚úÖ" || echo "‚ùå")
          APK="${{ steps.apk.outputs.name }}"
          URL="https://apps.8020solutions.org/downloads/test/${APK}"
          MSG="${EMOJI} ${{ github.event.repository.name }} build ${{ job.status }}\nBranch: ${{ steps.info.outputs.branch }}\nüîó ${URL}"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "ciccio-notify '${MSG}'" || true
